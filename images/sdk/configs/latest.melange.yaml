package:
  name: sdk
  version: 0.0.1
  epoch: 0
  description: Development tools for melange and apko
  target-architecture:
    - all
  copyright:
    - paths:
      - "*"
      attestation: TODO
      license: Apache-2.0
  dependencies:
    runtime:
      - alpine-baselayout-data
      - alpine-base
      - ca-certificates-bundle
      - apk-tools
      - make
      - go
      - git
      - curl
      - bash
      - bubblewrap
      - tree
      - python3

environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/edge/main
      - https://dl-cdn.alpinelinux.org/alpine/edge/community
    packages:
      - alpine-baselayout-data
      - alpine-base
      - busybox
      - ca-certificates-bundle
      - go
      - make
      - git
      - python3

pipeline:
  # Install gcloud and gsutil for either x86_64 or aarch64, but no other architectures.
  - if: ${{build.arch}} == "x86_64"
    uses: fetch
    with:
      uri: https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-410.0.0-linux-x86_64.tar.gz
      expected-sha256: de3525b315d7ea3c3696eba466ddd97313ccad45f6f684bcdd9224374baa6c08
  - if: ${{build.arch}} == "x86_64"
    runs: |
      install.sh
      install -m755 bin/gcloud "${{targets.destdir}}"/bin/gcloud
      install -m755 bin/gsutil "${{targets.destdir}}"/bin/gsutil
  - if: ${{build.arch}} == "aarch64"
    uses: fetch
    with:
      uri: https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-410.0.0-linux-arm.tar.gz
      expected-sha256: ce382528da5f5d5daf84f63ec4289ed60069e78f0cd8d9fa11c46ae5993854ea
  - if: ${{build.arch}} == "aarch64"
    runs: |
      install.sh
      install -m755 bin/gcloud "${{targets.destdir}}"/bin/gcloud
      install -m755 bin/gsutil "${{targets.destdir}}"/bin/gsutil

  - runs: |
      set -x

      export DESTDIR="${{targets.destdir}}"
      export PATH="${DESTDIR}/usr/bin:${DESTDIR}/root/.cache/go/bin:${PATH}"

      # go setup
      export GOPATH="${DESTDIR}/root/.cache/go"
      mkdir -p ${GOPATH}

      # goimports
      go install golang.org/x/tools/cmd/goimports@latest

      # melange
      git clone https://github.com/chainguard-dev/melange.git
      (cd melange && make melange install)

      # apko
      git clone https://github.com/chainguard-dev/apko.git
      (cd apko && make apko install)

      # sdk entrypoint
      SDK_ENTRYPOINT="${DESTDIR}/usr/bin/sdk"
      echo '#!/bin/bash -e' > "${SDK_ENTRYPOINT}"
      echo 'printf "\nWelcome to the development environment!\n\n\n"' >> "${SDK_ENTRYPOINT}"
      echo 'export PS1="[sdk] ❯ "' >> "${SDK_ENTRYPOINT}"
      echo 'export PATH="/root/.cache/go/bin:${PATH}"' >> "${SDK_ENTRYPOINT}"
      echo 'export GOPATH="/root/.cache/go"' >> "${SDK_ENTRYPOINT}"
      echo 'export CGO_ENABLED=0' >> "${SDK_ENTRYPOINT}"
      echo 'bash -i' >> "${SDK_ENTRYPOINT}"
      chmod +x "${SDK_ENTRYPOINT}"
