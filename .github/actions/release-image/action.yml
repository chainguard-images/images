name: release-image
runs:
  using: composite
  steps:
    - uses: actions/checkout@v3

    # Run custom melange build if necessary
    - name: Setup QEMU
      if: inputs.melangeConfig != ''
      uses: docker/setup-qemu-action@v2.1.0
    - id: melange
      if: inputs.melangeConfig != ''
      uses: chainguard-dev/actions/melange-build@main
      with:
        config: ${{ inputs.melangeConfig }}
        empty-workspace: true
        sign-with-temporary-key: true
        archs: ${{ inputs.melangeArchs }}
        template: ${{ inputs.melangeTemplate }}

    # If publishing to GCR, setup OIDC->SA auth
    - id: gcrauth1
      if: startsWith(inputs.apkoBaseTag, 'gcr.io/')
      uses: google-github-actions/auth@c4799db9111fba4461e9f9da8732e5057b394f72 #v0
      with:
        workload_identity_provider: ${{ secrets.GCRAUTH_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCRAUTH_SERVICE_ACCOUNT }}
    - id: gcrauth2
      if: startsWith(inputs.apkoBaseTag, 'gcr.io/')
      uses: google-github-actions/setup-gcloud@877d4953d2c70a0ba7ef3290ae968eb24af233bb #v0.6.0
      with:
        project_id: ${{ secrets.GCRAUTH_PROJECT_ID }}
        install_components: beta

    # Build and push
    - id: apko
      uses: chainguard-images/actions/apko-snapshot@main
      with:
        config: ${{ inputs.apkoConfig }}
        base-tag: ${{ inputs.apkoBaseTag }}
        target-tag: ${{ inputs.apkoTargetTag }}
        keyring-append: ${{ inputs.apkoKeyringAppend }}
        additional-tags: ${{ inputs.apkoAdditionalTags }}
        package-version-tag: ${{ inputs.apkoPackageVersionTag }}
        package-version-tag-stem: true
        package-version-tag-prefix: ${{ inputs.apkoPackageVersionTagPrefix }}

    # Test image
    - name: Smoke test
      id: smoketest
      if: inputs.testCommand != ''
      shell: bash
      run: |
        set -x
        IMAGE_NAME="${{ steps.apko.outputs.digest }}" \
          ${{ inputs.testCommand }}

    - name: Touch actions file to prevent postrun failure
      if: always()
      shell: bash
      run: |
        [[ -d .github/actions/release-image/action.yml ]] || ( \
          mkdir -p .github/actions/release-image/ && echo 'runs: {using: composite, steps: []}' > .github/actions/release-image/action.yml )
