name: build-image
runs:
  using: composite
  steps:
    - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
    - name: Setup QEMU
      if: inputs.melangeConfig != ''
      uses: docker/setup-qemu-action@e81a89b1732b9c48d79cd809d8d81d79c4647a18 # v2.1.0
    - id: melange
      if: inputs.melangeConfig != ''
      uses: chainguard-dev/actions/melange-build@main
      with:
        config: ${{ inputs.melangeConfig }}
        empty-workspace: true
        sign-with-temporary-key: true
        archs: ${{ inputs.melangeArchs }}
        template: ${{ inputs.melangeTemplate }}
    - id: apko
      uses: chainguard-images/actions/apko-build@main
      with:
        config: ${{ inputs.apkoConfig }}
        tag: ${{ inputs.imageName }}:${{ github.sha }}
        keyring-append: ${{ inputs.apkoKeyringAppend }}
        additional-tags: ${{ inputs.apkoAdditionalTags }}
    - name: Smoke test
      id: smoketest
      if: inputs.testCommandExe != ''
      shell: bash
      run: |
        set -x
        export IMAGE_NAME="$(docker load < output.tar | grep "Loaded image" | sed 's/^Loaded image: //')"
        cd "${{ inputs.testCommandDir }}"
        ${{ inputs.testCommandExe }}
    - name: Setup container structure test
      uses: ./.github/actions/setup-container-structure-test
      if: inputs.containerStructureTestConfig != ''
    - name: Run container structure test
      id: containerstructuretest
      if: inputs.containerStructureTestConfig != ''
      shell: bash
      run: |
        set -x
        export IMAGE_NAME="$(docker load < output.tar | grep "Loaded image" | sed 's/^Loaded image: //')"
        container-structure-test test \
          --image $IMAGE_NAME \
          --config ${{ inputs.containerStructureTestConfig }}
    - name: Touch actions file to prevent postrun failure
      if: always()
      shell: bash
      run: |
        set -x && [[ -f .github/actions/build-image/action.yml ]] || ( \
          mkdir -p .github/actions/build-image/ && echo 'runs: {using: composite, steps: []}' > .github/actions/build-image/action.yml )